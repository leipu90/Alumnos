<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SuriQuir贸fano | Seguimiento de Alumnos</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- FontAwesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    medical: {
                        50: '#f0fdfa',
                        100: '#ccfbf1',
                        500: '#14b8a6',
                        600: '#0d9488',
                        700: '#0f766e',
                        800: '#115e59',
                        900: '#134e4a',
                    }
                }
            }
        }
    }
</script>

<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8fafc; }
.fade-in { animation: fadeIn 0.3s ease-in-out; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    height: 16px;
    width: 16px;
    border-radius: 50%;
    background: #0d9488;
    cursor: pointer;
    margin-top: -6px;
}
input[type=range]::-webkit-slider-runnable-track {
    width: 100%;
    height: 4px;
    cursor: pointer;
    background: #ccfbf1;
    border-radius: 2px;
}
</style>
</head>
<body class="text-slate-700 h-screen flex flex-col overflow-hidden">

<nav class="bg-white border-b border-slate-200 shadow-sm z-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
            <div class="flex items-center cursor-pointer" onclick="app.renderDashboard()">
                <i class="fa-solid fa-heart-pulse text-medical-600 text-2xl mr-3"></i>
                <span class="font-bold text-xl text-slate-800 tracking-tight">Suri<span class="text-medical-600">Quir贸fano</span></span>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-sm text-slate-500 hidden sm:block">Modo actual:</span>
                <select id="roleSelector" onchange="app.setRole(this.value)" class="bg-slate-50 border border-slate-300 text-slate-900 text-sm rounded-lg focus:ring-medical-500 focus:border-medical-500 block p-2">
                    <option value="Docente"> Docente</option>
                    <option value="Enfermer铆a"> Enfermer铆a</option>
                </select>
            </div>
        </div>
    </div>
</nav>

<main class="flex-1 overflow-y-auto bg-slate-50 p-4 sm:p-8" id="mainContent"></main>

<div id="modalOverlay" class="fixed inset-0 bg-slate-900 bg-opacity-50 hidden items-center justify-center z-50 backdrop-blur-sm transition-opacity">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden transform transition-all scale-100">
        <div class="bg-medical-600 px-6 py-4 flex justify-between items-center">
            <h3 class="text-white font-semibold text-lg" id="modalTitle">T铆tulo Modal</h3>
            <button onclick="app.closeModal()" class="text-medical-100 hover:text-white transition">
                <i class="fa-solid fa-times text-xl"></i>
            </button>
        </div>
        <div class="p-6 max-h-[80vh] overflow-y-auto" id="modalContent"></div>
    </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.16.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.16.0/firebase-firestore-compat.js"></script>

<script>
  // Configuraci贸n de Firebase
  const firebaseConfig = {
    apiKey: "TU_API_KEY",
    authDomain: "TU_PROYECTO.firebaseapp.com",
    projectId: "TU_PROYECTO",
    storageBucket: "TU_PROYECTO.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
  };
  const fbApp = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
</script>

<script>
const app = (() => {
    const state = {
        students: [],
        currentUserRole: 'Docente',
        currentStudentId: null,
        chartInstance: null
    };

    const criteriaList = [
        { key: 'asepsia', label: 'Asepsia y Antisepsia' },
        { key: 'area', label: 'Conocimiento rea Quir煤rgica' },
        { key: 'instrumentacion', label: 'Instrumentaci贸n Quir煤rgica' },
        { key: 'seguridad', label: 'Seguridad del Paciente' },
        { key: 'equipo', label: 'Trabajo en Equipo y Comunicaci贸n' },
        { key: 'etica', label: 'Responsabilidad y tica' },
        { key: 'autonomia', label: 'Autonom铆a Progresiva' }
    ];

    // --- FIREBASE DATA ---
    async function loadData() {
        try {
            const snapshot = await db.collection('students').get();
            state.students = snapshot.docs.map(doc => doc.data());
        } catch (err) {
            console.error('Error cargando alumnos:', err);
            state.students = [];
        }
    }

    async function saveStudent(student) {
        try {
            await db.collection('students').doc(student.id).set(student);
        } catch (err) { console.error('Error guardando alumno:', err); }
    }

    async function saveEvaluation(studentId, evaluation) {
        try {
            const studentRef = db.collection('students').doc(studentId);
            await studentRef.update({
                evaluations: firebase.firestore.FieldValue.arrayUnion(evaluation)
            });
        } catch (err) { console.error('Error guardando evaluaci贸n:', err); }
    }

    function setRole(role) { state.currentUserRole = role; if(state.currentStudentId) renderStudentDetail(state.currentStudentId); else renderDashboard(); }

    function getColorForScore(score) {
        if(score === '-') return 'text-slate-400';
        if(score >= 9) return 'text-green-600';
        if(score >= 7) return 'text-teal-600';
        if(score >= 5) return 'text-yellow-600';
        return 'text-red-500';
    }

    function getBarColor(score) {
        if(score >= 9) return 'bg-green-500';
        if(score >= 7) return 'bg-teal-500';
        if(score >= 5) return 'bg-yellow-500';
        return 'bg-red-500';
    }

    function formatDate(dateString, short=false) {
        const options = short ? { day:'2-digit', month:'2-digit' } : { year:'numeric', month:'long', day:'numeric' };
        return new Date(dateString).toLocaleDateString('es-ES', options);
    }

    function getInitials(name) {
        return name.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase();
    }

    // --- RENDER DASHBOARD ---
    async function renderDashboard() {
        const container = document.getElementById('mainContent');
        await loadData();
        state.currentStudentId = null;

        const studentsWithAvg = state.students.map(s => {
            if(!s.evaluations || s.evaluations.length===0) return {...s, globalAvg:'-'};
            const sum = s.evaluations.reduce((acc,curr)=>acc+curr.average,0);
            return {...s, globalAvg:(sum/s.evaluations.length).toFixed(1)};
        });

        container.innerHTML = `
            <div class="max-w-7xl mx-auto fade-in">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-800">Panel de Seguimiento</h1>
                        <p class="text-slate-500 mt-1">Gesti贸n de evoluci贸n de alumnos en pr谩cticas</p>
                    </div>
                    ${state.currentUserRole==='Docente' ? `
                    <button onclick="app.openNewStudentModal()" class="bg-medical-600 hover:bg-medical-700 text-white px-5 py-2.5 rounded-lg shadow-md transition flex items-center gap-2">
                        <i class="fa-solid fa-user-plus"></i> Nuevo Alumno
                    </button>` : ''}
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <div class="text-slate-400 text-sm font-medium uppercase">Total Alumnos</div>
                        <div class="text-3xl font-bold text-slate-800 mt-2">${state.students.length}</div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <div class="text-slate-400 text-sm font-medium uppercase">Evaluaciones Realizadas</div>
                        <div class="text-3xl font-bold text-medical-600 mt-2">${state.students.reduce((acc,s)=>acc+(s.evaluations?s.evaluations.length:0),0)}</div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 text-slate-500 uppercase text-xs font-semibold">
                            <tr>
                                <th class="p-5 border-b border-slate-200">Alumno</th>
                                <th class="p-5 border-b border-slate-200 hidden sm:table-cell">Curso</th>
                                <th class="p-5 border-b border-slate-200">Evaluaciones</th>
                                <th class="p-5 border-b border-slate-200">Promedio Global</th>
                                <th class="p-5 border-b border-slate-200 text-right">Acci贸n</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            ${studentsWithAvg.length===0 ? `<tr><td colspan="5" class="p-8 text-center text-slate-400">No hay alumnos registrados.</td></tr>` : studentsWithAvg.map(student => `
                                <tr class="hover:bg-slate-50 transition cursor-pointer" onclick="app.renderStudentDetail('${student.id}')">
                                    <td class="p-5">
                                        <div class="font-semibold text-slate-800">${student.name}</div>
                                        <div class="text-xs text-slate-400">ID: ${student.dni}</div>
                                    </td>
                                    <td class="p-5 hidden sm:table-cell text-slate-600">${student.course}</td>
                                    <td class="p-5"><span class="bg-slate-100 text-slate-600 py-1 px-3 rounded-full text-xs font-bold">${student.evaluations?s.evaluations.length:0}</span></td>
                                    <td class="p-5"><span class="${getColorForScore(student.globalAvg)} font-bold">${student.globalAvg}</span></td>
                                    <td class="p-5 text-right">
                                        <button class="text-medical-600 hover:text-medical-800 font-medium text-sm">Ver Detalle <i class="fa-solid fa-chevron-right ml-1"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    // --- MODAL NUEVO ALUMNO ---
    function closeModal() { document.getElementById('modalOverlay').classList.add('hidden'); document.getElementById('modalOverlay').classList.remove('flex'); }

    function openModal(title, htmlContent) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalContent').innerHTML = htmlContent;
        const modal = document.getElementById('modalOverlay');
        modal.classList.remove('hidden'); modal.classList.add('flex');
    }

    function openNewStudentModal() {
        const formHtml = `
            <form onsubmit="app.handleAddStudent(event)" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Nombre Completo</label>
                        <input type="text" name="name" required class="w-full border-slate-300 rounded-lg p-2.5 border focus:ring-medical-500 focus:border-medical-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">DNI / ID</label>
                        <input type="text" name="dni" required class="w-full border-slate-300 rounded-lg p-2.5 border focus:ring-medical-500 focus:border-medical-500 outline-none">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Curso / Ciclo</label>
                        <select name="course" class="w-full border-slate-300 rounded-lg p-2.5 border focus:ring-medical-500 focus:border-medical-500 outline-none">
                            <option>Pr谩cticas I</option>
                            <option>Pr谩cticas II</option>
                            <option>Residencia</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Fecha de Ingreso</label>
                        <input type="date" name="startDate" required class="w-full border-slate-300 rounded-lg p-2.5 border focus:ring-medical-500 focus:border-medical-500 outline-none">
                    </div>
                </div>
                <div class="pt-4 flex justify-end gap-3">
                    <button type="button" onclick="app.closeModal()" class="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg transition">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-medical-600 hover:bg-medical-700 text-white rounded-lg font-medium transition shadow-sm">Guardar Alumno</button>
                </div>
            </form>
        `;
        openModal('Registrar Nuevo Alumno', formHtml);
    }

    async function handleAddStudent(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const newStudent = {
            id: 'ALU-' + Date.now().toString().slice(-6),
            name: formData.get('name'),
            dni: formData.get('dni'),
            course: formData.get('course'),
            startDate: formData.get('startDate'),
            evaluations: []
        };
        state.students.push(newStudent);
        await saveStudent(newStudent);
        closeModal();
        renderDashboard();
    }

    return { renderDashboard, openNewStudentModal, handleAddStudent, setRole };
})();

document.addEventListener('DOMContentLoaded', app.renderDashboard);
</script>
</body>
</html>
