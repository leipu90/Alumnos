<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seguimiento Alumnos Quirófano</title>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    /* Estilo limpio y colores orgánicos */
    body { font-family: Arial, sans-serif; background: #f5f7f6; color: #333; margin:0; padding:0;}
    header { background: #a8d5ba; padding: 1rem; text-align:center; color: #fff;}
    h1 { margin:0;}
    main { max-width: 900px; margin: 2rem auto; padding:1rem; background:#fff; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.1);}
    section { margin-bottom:2rem;}
    input, select, textarea, button { padding:0.5rem; margin:0.3rem 0; width:100%; border-radius:5px; border:1px solid #ccc; font-size:1rem;}
    button { background:#7bbd7b; color:#fff; border:none; cursor:pointer; }
    button:hover { background:#5aa65a; }
    canvas { max-width:100%; margin-top:1rem; }
    .flex { display:flex; gap:1rem; flex-wrap:wrap; }
    .flex > * { flex:1;}
  </style>
</head>
<body>

<header>
  <h1>Seguimiento de Alumnos - Quirófano</h1>
</header>

<main>
  <!-- Formulario Alumno -->
  <section>
    <h2>Agregar Alumno</h2>
    <input type="text" id="nombreAlumno" placeholder="Nombre completo">
    <input type="text" id="dniAlumno" placeholder="DNI">
    <input type="text" id="cursoAlumno" placeholder="Curso">
    <input type="date" id="fechaIngresoAlumno">
    <button onclick="agregarAlumno()">Agregar Alumno</button>
  </section>

  <!-- Formulario Evaluación -->
  <section>
    <h2>Agregar Evaluación</h2>
    <select id="alumnoSelect"></select>
    <select id="evaluadorSelect">
      <option value="Docente">Docente</option>
      <option value="Enfermería">Enfermería</option>
    </select>
    <div class="flex">
      <input type="number" id="asepsia" placeholder="Asepsia y antisepsia" min="1" max="10">
      <input type="number" id="conocimiento" placeholder="Conocimiento área quirúrgica" min="1" max="10">
      <input type="number" id="instrumentacion" placeholder="Instrumentación quirúrgica" min="1" max="10">
      <input type="number" id="seguridad" placeholder="Seguridad del paciente" min="1" max="10">
      <input type="number" id="equipo" placeholder="Trabajo en equipo y comunicación" min="1" max="10">
      <input type="number" id="responsabilidad" placeholder="Responsabilidad y ética profesional" min="1" max="10">
      <input type="number" id="autonomia" placeholder="Autonomía progresiva" min="1" max="10">
    </div>
    <textarea id="observaciones" placeholder="Observaciones"></textarea>
    <button onclick="agregarEvaluacion()">Agregar Evaluación</button>
  </section>

  <!-- Gráfico Evolución -->
  <section>
    <h2>Evolución del Alumno</h2>
    <select id="alumnoGraficoSelect" onchange="cargarEvolucion()"></select>
    <canvas id="graficoEvolucion"></canvas>
  </section>
</main>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "TU_API_KEY",
    authDomain: "TU_PROYECTO.firebaseapp.com",
    projectId: "TU_PROYECTO",
    storageBucket: "TU_PROYECTO.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let alumnos = [];

  // Cargar alumnos en selects
  function cargarAlumnos() {
    db.collection("alumnos").get().then(snapshot=>{
      alumnos = [];
      const select = document.getElementById("alumnoSelect");
      const graficoSelect = document.getElementById("alumnoGraficoSelect");
      select.innerHTML = "";
      graficoSelect.innerHTML = "";
      snapshot.forEach(doc=>{
        const data = doc.data();
        alumnos.push({id: doc.id, ...data});
        const option1 = document.createElement("option");
        option1.value = doc.id;
        option1.textContent = data.nombre;
        select.appendChild(option1);
        const option2 = option1.cloneNode(true);
        graficoSelect.appendChild(option2);
      });
    });
  }

  cargarAlumnos();

  // Agregar alumno
  function agregarAlumno() {
    const nombre = document.getElementById("nombreAlumno").value;
    const dni = document.getElementById("dniAlumno").value;
    const curso = document.getElementById("cursoAlumno").value;
    const fechaIngreso = document.getElementById("fechaIngresoAlumno").value;
    if(!nombre||!dni||!curso||!fechaIngreso){ alert("Completa todos los campos"); return; }
    db.collection("alumnos").add({nombre,dni,curso,fechaIngreso})
      .then(()=>{ alert("Alumno agregado"); cargarAlumnos(); })
      .catch(err=>console.error(err));
  }

  // Agregar evaluación
  function agregarEvaluacion() {
    const alumnoId = document.getElementById("alumnoSelect").value;
    const evaluador = document.getElementById("evaluadorSelect").value;
    const puntajes = {
      asepsia: parseInt(document.getElementById("asepsia").value),
      conocimiento: parseInt(document.getElementById("conocimiento").value),
      instrumentacion: parseInt(document.getElementById("instrumentacion").value),
      seguridad: parseInt(document.getElementById("seguridad").value),
      equipo: parseInt(document.getElementById("equipo").value),
      responsabilidad: parseInt(document.getElementById("responsabilidad").value),
      autonomia: parseInt(document.getElementById("autonomia").value)
    };
    const observaciones = document.getElementById("observaciones").value;
    db.collection("evaluaciones").add({
      alumnoId, fecha: new Date().toISOString().slice(0,10),
      evaluador, puntajes, observaciones
    })
    .then(()=>{ alert("Evaluación agregada"); cargarEvolucion(); })
    .catch(err=>console.error(err));
  }

  // Gráfico
  let chart;
  function cargarEvolucion() {
    const alumnoId = document.getElementById("alumnoGraficoSelect").value;
    db.collection("evaluaciones").where("alumnoId","==",alumnoId).orderBy("fecha").get()
      .then(snapshot=>{
        const labels = [];
        const promedios = [];
        snapshot.forEach(doc=>{
          const data = doc.data();
          labels.push(data.fecha);
          const values = Object.values(data.puntajes);
          const promedio = values.reduce((a,b)=>a+b,0)/values.length;
          promedios.push(promedio);
        });
        if(chart) chart.destroy();
        const ctx = document.getElementById("graficoEvolucion").getContext("2d");
        chart = new Chart(ctx,{
          type:'line',
          data:{labels, datasets:[{
            label:'Promedio general',
            data:promedios,
            borderColor:'rgba(75,192,192,1)',
            backgroundColor:'rgba(75,192,192,0.2)',
            fill:true,
            tension:0.3
          }]},
          options:{responsive:true, scales:{y:{beginAtZero:true, max:10}}}
        });
      });
  }

  // Cargar evolución del primer alumno por defecto
  setTimeout(()=>{ if(alumnos.length>0)cargarEvolucion(); },1000);
</script>

</body>
</html>
