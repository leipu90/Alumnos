<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OR-Track: Panel de Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .sanitary-gradient { background: linear-gradient(180deg, #0f766e 0%, #115e59 100%); }
        
        /* Table Styles */
        .table-row-hover:hover td { background-color: #f0fdfa; }
        th { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; font-weight: 700; }
        td { font-size: 0.875rem; color: #334155; }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 16px; height: 16px; background: #0d9488;
            cursor: pointer; border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, addDoc, updateDoc, deleteDoc, orderBy, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // ÁREA DE CONFIGURACIÓN (GitHub Pages)
        // ==========================================
        // 1. Crea un proyecto gratis en console.firebase.google.com
        // 2. Registra una app web y copia el objeto 'firebaseConfig'
        // 3. Descomenta las líneas de abajo y pega tu configuración:
        
        const GITHUB_FIREBASE_CONFIG = null; 
        
        /* EJEMPLO: (Borra el null de arriba y descomenta esto)
        const GITHUB_FIREBASE_CONFIG = {
            apiKey: "AIzaSyB...",
            authDomain: "tu-proyecto.firebaseapp.com",
            projectId: "tu-proyecto",
            storageBucket: "tu-proyecto.appspot.com",
            messagingSenderId: "123456...",
            appId: "1:123456..."
        };
        */
        // ==========================================

        // State
        let students = [];
        let currentRole = 'docente';
        let activeChart = null;
        let currentUser = null;
        let db, auth;
        let unsubscribe = null;
        let isOfflineMode = false;
        // ID por defecto para standalone
        const DEFAULT_APP_ID = 'or-track-demo'; 

        const criteria = [
            { id: 'entorno', label: 'Entorno y Almacenamiento', short: 'Entorno' },
            { id: 'equipamiento', label: 'Tecnología y Equipamiento', short: 'Equipos' },
            { id: 'seguridad', label: 'Seguridad y Procedimientos', short: 'Seguridad' },
            { id: 'asepsia', label: 'Técnicas Estériles', short: 'Asepsia' },
            { id: 'instrumental', label: 'Instrumental Especializado', short: 'Instrum.' },
            { id: 'anestesia', label: 'Asistencia en Anestesia', short: 'Anestes.' },
            { id: 'funciones', label: 'Roles de Enfermería', short: 'Roles' },
            { id: 'comunicacion', label: 'Comunicación y Registros', short: 'Comun.' }
        ];

        // --- INIT & SYNC ---
        const initApp = async () => {
            updateConnectionStatus('connecting');
            
            try {
                let firebaseConfig;

                // Lógica de selección de configuración
                if (GITHUB_FIREBASE_CONFIG) {
                    firebaseConfig = GITHUB_FIREBASE_CONFIG; // Usa la config manual si existe
                } else if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    firebaseConfig = JSON.parse(__firebase_config); // Usa la del entorno actual
                } else {
                    throw new Error("No se encontró configuración de Firebase. Activa el modo local.");
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Autenticación
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    if (user) {
                        updateConnectionStatus('connected');
                        // Usar un ID de app fijo si estamos en GitHub, o el dinámico si estamos aquí
                        const appId = (typeof __app_id !== 'undefined') ? __app_id : DEFAULT_APP_ID;
                        setupRealtimeListener(appId);
                    } else {
                        enableOfflineMode();
                    }
                });

            } catch (error) {
                console.warn("Iniciando en Modo Local (Offline):", error.message);
                enableOfflineMode();
            }
        };

        const setupRealtimeListener = (appId) => {
            if (unsubscribe) unsubscribe();

            // Nota: En un entorno real, la ruta de la colección sería más simple, ej: 'students'
            // Aquí mantenemos la estructura compatible con el prototipo original
            const collectionPath = (typeof __app_id !== 'undefined') 
                ? collection(db, 'artifacts', appId, 'public', 'data', 'students') // Entorno Demo
                : collection(db, 'students'); // Entorno Producción (GitHub)

            unsubscribe = onSnapshot(collectionPath, (snapshot) => {
                const newStudents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                students = newStudents;
                isOfflineMode = false;
                updateStats();
                renderTable();
            }, (error) => {
                console.error("Error de sincronización:", error);
                // Si falla por permisos (ej. reglas de firestore), volvemos a local
                enableOfflineMode();
            });
        };

        // --- OFFLINE MODE HANDLERS ---
        const enableOfflineMode = () => {
            isOfflineMode = true;
            updateConnectionStatus('offline');
            loadLocalData();
            showToast("Modo Local Activado");
        };

        const loadLocalData = () => {
            const localData = localStorage.getItem('or_track_local_students');
            if (localData) {
                students = JSON.parse(localData);
            } else {
                students = [
                    {
                        id: 'demo1', name: 'Ana Martínez', dni: '12345678A', course: 'Rotación 1', createdAt: new Date().toISOString(),
                        evaluations: [
                            { week: '1', date: '2024-02-01', evaluator: 'Docente Supervisor', avg: 6.5, scores: {}, notes: 'Buen inicio.' },
                            { week: '2', date: '2024-02-08', evaluator: 'Enf. Quirófano', avg: 8.0, scores: {}, notes: 'Mejora notable en asepsia.' }
                        ]
                    }
                ];
                saveLocalData();
            }
            updateStats();
            renderTable();
        };

        const saveLocalData = () => {
            localStorage.setItem('or_track_local_students', JSON.stringify(students));
            updateStats();
            renderTable();
        };

        const updateConnectionStatus = (status) => {
            const el = document.getElementById('connection-badge');
            const text = document.getElementById('connection-text');
            const icon = document.getElementById('connection-icon');

            if (status === 'connected') {
                el.className = "flex items-center gap-2 bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full border border-emerald-200";
                text.innerText = "Nube Conectada";
                icon.setAttribute('data-lucide', 'wifi');
            } else if (status === 'connecting') {
                el.className = "flex items-center gap-2 bg-slate-100 text-slate-600 px-3 py-1 rounded-full border border-slate-200 animate-pulse";
                text.innerText = "Conectando...";
                icon.setAttribute('data-lucide', 'loader-2');
            } else { 
                el.className = "flex items-center gap-2 bg-orange-100 text-orange-700 px-3 py-1 rounded-full border border-orange-200";
                text.innerText = "Modo Local";
                icon.setAttribute('data-lucide', 'hard-drive');
            }
            lucide.createIcons();
        };

        // --- RENDER LOGIC ---
        const updateStats = () => {
            const total = students.length;
            const activeEvals = students.reduce((acc, s) => acc + (s.evaluations?.length || 0), 0);
            
            let globalSum = 0;
            let count = 0;
            students.forEach(s => {
                if (s.evaluations?.length) {
                    const studentAvg = s.evaluations.reduce((a, b) => a + b.avg, 0) / s.evaluations.length;
                    globalSum += studentAvg;
                    count++;
                }
            });
            const globalAvg = count ? (globalSum / count).toFixed(1) : '0.0';

            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-evals').innerText = activeEvals;
            document.getElementById('stat-avg').innerText = globalAvg;
        };

        const renderTable = () => {
            const tbody = document.getElementById('students-table-body');
            tbody.innerHTML = '';

            if (students.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-slate-400 italic bg-white rounded-b-xl">No hay alumnos. Crea uno nuevo.</td></tr>`;
                return;
            }

            students.forEach(s => {
                const evals = s.evaluations || [];
                const lastEval = evals.length > 0 ? evals[evals.length - 1] : null;
                const avg = evals.length > 0 ? (evals.reduce((acc, curr) => acc + curr.avg, 0) / evals.length).toFixed(1) : '-';
                const progressColor = avg >= 7 ? 'text-emerald-600 bg-emerald-50' : (avg >= 5 ? 'text-amber-600 bg-amber-50' : 'text-slate-400 bg-slate-50');
                const lastDate = lastEval ? new Date(lastEval.date).toLocaleDateString('es-ES', { day: '2-digit', month: 'short' }) : '-';
                const week = lastEval ? `Sem. ${lastEval.week}` : 'Nuevo';

                const tr = document.createElement('tr');
                tr.className = "border-b border-slate-100 table-row-hover transition-colors bg-white last:border-0";
                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-teal-700 font-bold text-xs border border-slate-200 shadow-sm">
                                ${s.name.charAt(0)}
                            </div>
                            <div>
                                <div class="font-bold text-slate-900">${s.name}</div>
                                <div class="text-xs text-slate-500">${s.dni}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4"><span class="text-xs font-medium px-2 py-1 rounded bg-slate-50 text-slate-600 border border-slate-200">${s.course}</span></td>
                    <td class="px-6 py-4 text-sm font-medium text-slate-600">${week}</td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-2">
                            <span class="${progressColor} px-2 py-1 rounded font-bold text-sm border border-black/5 w-12 text-center inline-block">${avg}</span>
                            ${avg !== '-' ? renderMiniBar(avg) : ''}
                        </div>
                    </td>
                    <td class="px-6 py-4 text-xs font-medium text-slate-500">${lastDate}</td>
                    <td class="px-6 py-4">
                        <div class="flex gap-2 justify-end">
                            <button onclick="window.openEvaluation('${s.id}')" class="p-2 text-slate-400 hover:text-teal-600 hover:bg-teal-50 rounded-lg transition-all"><i data-lucide="clipboard-check" class="w-4 h-4"></i></button>
                            <button onclick="window.viewDetails('${s.id}')" class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all"><i data-lucide="bar-chart-2" class="w-4 h-4"></i></button>
                            ${currentRole === 'docente' ? `<button onclick="window.deleteStudent('${s.id}')" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        };

        const renderMiniBar = (val) => {
            const pct = (val / 10) * 100;
            const color = val >= 7 ? '#059669' : '#d97706';
            return `<div class="w-16 h-1.5 bg-slate-200 rounded-full overflow-hidden"><div class="h-full rounded-full" style="width:${pct}%; background:${color}"></div></div>`;
        };

        // --- ACTIONS ---
        window.saveStudent = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-save-student');
            btn.innerText = "Guardando...";
            btn.disabled = true;

            const newStu = {
                id: isOfflineMode ? Date.now().toString() : undefined,
                name: document.getElementById('stuName').value,
                dni: document.getElementById('stuDni').value,
                course: document.getElementById('stuCourse').value,
                joinDate: document.getElementById('stuDate').value,
                evaluations: [],
                createdAt: new Date().toISOString()
            };

            try {
                if (isOfflineMode) {
                    students.push(newStu);
                    saveLocalData();
                } else {
                    const appId = (typeof __app_id !== 'undefined') ? __app_id : DEFAULT_APP_ID;
                    const collectionPath = (typeof __app_id !== 'undefined') 
                        ? collection(db, 'artifacts', appId, 'public', 'data', 'students')
                        : collection(db, 'students');
                        
                    await addDoc(collectionPath, newStu);
                }
                window.closeModal('modal-add');
                e.target.reset();
                showToast(isOfflineMode ? "Guardado Localmente" : "Guardado en Nube");
            } catch (err) {
                console.error(err);
                showToast("Error al guardar");
            } finally {
                btn.innerText = "Guardar";
                btn.disabled = false;
            }
        };

        window.saveEvaluation = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-save-eval');
            btn.disabled = true;
            btn.innerText = "Procesando...";

            const studentId = document.getElementById('evalStudentId').value;
            const student = students.find(s => s.id === studentId);
            
            const scores = {};
            let sum = 0;
            criteria.forEach(c => {
                const val = parseInt(document.getElementById(`input-${c.id}`).value);
                scores[c.id] = val;
                sum += val;
            });

            const newEval = {
                week: document.getElementById('evalWeek').value,
                date: new Date().toISOString().split('T')[0],
                evaluator: currentRole === 'docente' ? 'Docente Supervisor' : 'Enf. Quirófano',
                scores,
                avg: parseFloat((sum / criteria.length).toFixed(1)),
                notes: document.getElementById('evalNotes').value,
                timestamp: Date.now()
            };

            const updatedEvals = [...(student.evaluations || []), newEval];

            try {
                if (isOfflineMode) {
                    student.evaluations = updatedEvals;
                    saveLocalData();
                } else {
                    const appId = (typeof __app_id !== 'undefined') ? __app_id : DEFAULT_APP_ID;
                    const docPath = (typeof __app_id !== 'undefined') 
                        ? doc(db, 'artifacts', appId, 'public', 'data', 'students', studentId)
                        : doc(db, 'students', studentId);
                        
                    await updateDoc(docPath, { evaluations: updatedEvals });
                }
                window.closeModal('modal-eval');
                showToast("Evaluación guardada");
            } catch (err) {
                console.error(err);
                showToast("Error al guardar");
            } finally {
                btn.disabled = false;
                btn.innerText = "Guardar Evaluación";
            }
        };

        window.deleteStudent = async (id) => {
            if (!confirm("¿Eliminar registro?")) return;
            try {
                if (isOfflineMode) {
                    students = students.filter(s => s.id !== id);
                    saveLocalData();
                } else {
                    const appId = (typeof __app_id !== 'undefined') ? __app_id : DEFAULT_APP_ID;
                    const docPath = (typeof __app_id !== 'undefined') 
                        ? doc(db, 'artifacts', appId, 'public', 'data', 'students', id)
                        : doc(db, 'students', id);
                    await deleteDoc(docPath);
                }
                showToast("Eliminado");
            } catch (err) {
                showToast("Error al eliminar");
            }
        };

        // --- UI HELPERS ---
        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        
        window.openEvaluation = (id) => {
            const s = students.find(x => x.id === id);
            document.getElementById('evalStudentId').value = id;
            document.getElementById('evalStudentName').innerText = s.name;
            const container = document.getElementById('criteriaList');
            container.innerHTML = '';
            criteria.forEach(c => {
                const div = document.createElement('div');
                div.className = "mb-4";
                div.innerHTML = `
                    <div class="flex justify-between mb-1">
                        <label class="text-xs font-bold text-slate-500 uppercase">${c.label}</label>
                        <span id="val-${c.id}" class="text-xs font-bold text-teal-700 bg-teal-50 px-2 rounded">5</span>
                    </div>
                    <input type="range" id="input-${c.id}" min="1" max="10" value="5" 
                           class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-teal-600"
                           oninput="document.getElementById('val-${c.id}').innerText = this.value">
                `;
                container.appendChild(div);
            });
            window.openModal('modal-eval');
        };

        window.viewDetails = (id) => {
            const s = students.find(x => x.id === id);
            document.getElementById('detailName').innerText = s.name;
            document.getElementById('detailInfo').innerText = `${s.course} • ${s.dni}`;
            
            const histDiv = document.getElementById('detailHistory');
            histDiv.innerHTML = '';
            const evals = [...(s.evaluations || [])].reverse();
            
            if (evals.length === 0) histDiv.innerHTML = '<div class="text-center text-slate-400 py-4">Sin datos</div>';
            
            evals.forEach(ev => {
                const item = document.createElement('div');
                item.className = "bg-slate-50 p-4 rounded-xl border border-slate-100 mb-3";
                item.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold text-teal-700 uppercase">Semana ${ev.week}</span>
                        <span class="text-xs text-slate-400">${ev.date}</span>
                    </div>
                    <div class="flex justify-between items-end">
                        <div class="text-xs text-slate-600 italic">"${ev.notes || '...'}"</div>
                        <div class="text-lg font-black text-slate-800">${ev.avg}</div>
                    </div>
                `;
                histDiv.appendChild(item);
            });

            const ctx = document.getElementById('evolutionChart').getContext('2d');
            if (activeChart) activeChart.destroy();
            activeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: evals.reverse().map(e => `S${e.week}`),
                    datasets: [{
                        label: 'Evolución',
                        data: evals.map(e => e.avg),
                        borderColor: '#0d9488',
                        backgroundColor: 'rgba(13, 148, 136, 0.1)',
                        fill: true, tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { min: 0, max: 10 } } }
            });
            window.openModal('modal-details');
        };

        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
        };

        window.toggleRole = () => {
            currentRole = document.getElementById('roleSelect').value;
            const btn = document.getElementById('btnAddMain');
            if(currentRole === 'enfermeria') btn.classList.add('hidden');
            else btn.classList.remove('hidden');
            renderTable();
        };

        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            lucide.createIcons();
        });

    </script>
</head>
<body class="text-slate-800">

    <!-- Navbar -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="bg-teal-600 text-white p-1.5 rounded-lg">
                    <i data-lucide="activity" class="w-5 h-5"></i>
                </div>
                <h1 class="font-bold text-lg tracking-tight text-slate-800">OR-Track <span class="text-slate-400 font-normal">| Manager</span></h1>
            </div>
            
            <div class="flex items-center gap-4">
                <div id="connection-badge" class="flex items-center gap-2 bg-slate-100 px-3 py-1 rounded-full border border-slate-200 transition-all">
                    <i id="connection-icon" data-lucide="loader-2" class="w-3 h-3"></i>
                    <span id="connection-text" class="text-xs font-bold">Iniciando...</span>
                </div>

                <div class="hidden md:flex items-center gap-2 bg-slate-100 rounded-lg p-1">
                    <select id="roleSelect" onchange="toggleRole()" class="bg-transparent text-xs font-bold text-slate-600 px-2 py-1 outline-none cursor-pointer">
                        <option value="docente">Vista Docente</option>
                        <option value="enfermeria">Vista Enfermería</option>
                    </select>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total Alumnos</p>
                    <p id="stat-total" class="text-3xl font-black text-slate-800 mt-1">0</p>
                </div>
                <div class="p-3 bg-blue-50 text-blue-600 rounded-lg"><i data-lucide="users" class="w-6 h-6"></i></div>
            </div>
            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Evaluaciones</p>
                    <p id="stat-evals" class="text-3xl font-black text-slate-800 mt-1">0</p>
                </div>
                <div class="p-3 bg-teal-50 text-teal-600 rounded-lg"><i data-lucide="file-check" class="w-6 h-6"></i></div>
            </div>
            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                <div>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Promedio Global</p>
                    <p id="stat-avg" class="text-3xl font-black text-slate-800 mt-1">0.0</p>
                </div>
                <div class="p-3 bg-purple-50 text-purple-600 rounded-lg"><i data-lucide="trending-up" class="w-6 h-6"></i></div>
            </div>
        </div>

        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h2 class="font-bold text-slate-800 flex items-center gap-2">
                    <i data-lucide="list" class="w-4 h-4 text-slate-400"></i> Seguimiento de Rotación
                </h2>
                <button id="btnAddMain" onclick="openModal('modal-add')" class="bg-teal-600 hover:bg-teal-700 text-white text-xs font-bold px-4 py-2 rounded-lg flex items-center gap-2 transition-all shadow-sm">
                    <i data-lucide="plus" class="w-4 h-4"></i> Nuevo Alumno
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th class="px-6 py-3">Alumno</th>
                            <th class="px-6 py-3">Rotación</th>
                            <th class="px-6 py-3">Fase</th>
                            <th class="px-6 py-3">Rendimiento</th>
                            <th class="px-6 py-3">Última Actividad</th>
                            <th class="px-6 py-3 text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="students-table-body">
                        <!-- Rows injected here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modals (Add, Eval, Details) -->
    <div id="modal-add" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl">
            <h3 class="text-xl font-bold mb-4">Nuevo Alumno</h3>
            <form onsubmit="saveStudent(event)" class="space-y-4">
                <input type="text" id="stuName" placeholder="Nombre Completo" required class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-teal-500">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="stuDni" placeholder="DNI" required class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-teal-500">
                    <input type="date" id="stuDate" required class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-teal-500">
                </div>
                <input type="text" id="stuCourse" placeholder="Rotación / Curso" required class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-teal-500">
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('modal-add')" class="flex-1 py-2 text-slate-500 font-bold">Cancelar</button>
                    <button type="submit" id="btn-save-student" class="flex-1 bg-teal-600 text-white font-bold py-2 rounded-lg hover:bg-teal-700">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-eval" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl max-h-[90vh] overflow-y-auto custom-scrollbar">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 class="text-xl font-bold">Nueva Evaluación</h3>
                    <p id="evalStudentName" class="text-teal-600 font-medium text-sm"></p>
                </div>
                <select id="evalWeek" class="text-xs bg-slate-100 border-none rounded px-2 py-1 font-bold">
                    <option value="1">Semana 1</option>
                    <option value="2">Semana 2</option>
                    <option value="3">Semana 3</option>
                    <option value="4">Semana 4</option>
                    <option value="5">Semana 5</option>
                    <option value="6">Semana 6</option>
                    <option value="7">Semana 7</option>
                    <option value="8">Semana 8</option>
                </select>
            </div>
            <form onsubmit="saveEvaluation(event)">
                <input type="hidden" id="evalStudentId">
                <div id="criteriaList" class="mb-6"></div>
                <textarea id="evalNotes" rows="2" placeholder="Observaciones..." class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:border-teal-500 mb-4"></textarea>
                <div class="flex gap-3">
                    <button type="button" onclick="closeModal('modal-eval')" class="flex-1 py-2 text-slate-500 font-bold">Cancelar</button>
                    <button type="submit" id="btn-save-eval" class="flex-1 bg-teal-600 text-white font-bold py-2 rounded-lg hover:bg-teal-700">Guardar Evaluación</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-details" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-3xl p-6 shadow-2xl h-[80vh] flex flex-col">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 id="detailName" class="text-2xl font-bold"></h3>
                    <p id="detailInfo" class="text-slate-500"></p>
                </div>
                <button onclick="closeModal('modal-details')" class="p-2 bg-slate-100 rounded-full hover:bg-slate-200"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-1 overflow-hidden">
                <div class="flex flex-col h-full">
                    <h4 class="font-bold text-slate-400 text-xs uppercase mb-2">Progreso</h4>
                    <div class="bg-white border border-slate-100 rounded-xl p-2 flex-1 relative min-h-[200px]">
                        <canvas id="evolutionChart"></canvas>
                    </div>
                </div>
                <div class="flex flex-col h-full overflow-hidden">
                    <h4 class="font-bold text-slate-400 text-xs uppercase mb-2">Historial</h4>
                    <div id="detailHistory" class="flex-1 overflow-y-auto custom-scrollbar pr-2"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 right-8 bg-slate-800 text-white px-5 py-3 rounded-xl shadow-lg transform translate-y-20 opacity-0 transition-all duration-300 z-[100] flex items-center gap-3">
        <i data-lucide="info" class="text-teal-400 w-5 h-5"></i>
        <span id="toastMsg" class="font-medium text-sm">Notificación</span>
    </div>

</body>
</html>